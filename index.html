<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e67e22">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osmanlı Padişahları Bilgi Oyunu</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap');

        :root {
            --primary-color: #e67e22; /* Canlı Turuncu */
            --secondary-color: #ecf0f1; /* Açık Gri */
            --dark-color: #0D1B2A;     /* Çok Koyu Mavi */
            --container-bg: rgba(27, 38, 49, 0.9); /* Yarı saydam Koyu Mavi */
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --btn-bg: #415A77;       /* Orta Ton Mavi */
            --btn-hover-bg: #e67e22;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0D1B2A, #1B2631, #415A77);
            color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 95%;
            max-width: 700px;
            background-color: var(--container-bg);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 25px 35px;
            box-shadow: 0 0 30px rgba(230, 126, 34, 0.4);
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .screen {
            display: none;
            animation: fadeIn 0.7s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            text-shadow: 1px 1px 3px #000;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr; /* Mobil için varsayılan */
            gap: 20px;
            margin: 25px 0;
            text-align: left;
        }
        
        @media (min-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr 1fr; /* Masaüstü için 2x2 grid */
            }
        }

        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--primary-color);
            background-color: var(--dark-color);
            color: var(--secondary-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1em;
            box-sizing: border-box;
        }

        .btn {
            background-color: var(--btn-bg);
            color: var(--secondary-color);
            border: 1px solid var(--primary-color);
            padding: 12px 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            width: auto;
            margin: 5px;
        }
        
        .btn-small {
            font-size: 0.8em;
            padding: 4px 8px;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--btn-hover-bg);
            color: #fff;
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.6);
        }
        .btn:disabled {
            background-color: #555;
            border-color: #777;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        #game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            flex-wrap: wrap;
        }

        #timer {
            background-color: var(--btn-bg);
            min-width: 50px;
            height: 50px;
            border-radius: 50%;
            padding: 0 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4em;
            font-weight: bold;
            border: 2px solid var(--primary-color);
            flex-shrink: 0;
            transition: all 0.5s ease;
        }

        #question-text {
            font-size: 1.7em;
            margin: 30px 0;
            line-height: 1.4;
            font-family: 'Playfair Display', serif;
        }
        
        #mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .mcq-btn {
            width: 100%;
            min-height: 60px;
            font-size: 1em;
            padding: 10px;
        }

        #feedback-area {
            margin-top: 20px;
            min-height: 120px;
        }
        #feedback-status-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        #feedback-status {
            font-size: 1.5em; 
            font-weight: bold;
            flex-grow: 1;
            text-align: left;
        }
        #feedback-details {
            font-size: 0.95em; margin-top: 10px; line-height: 1.6; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;
        }
        #feedback-details small { color: var(--primary-color); opacity: 0.8;}
        #feedback-status.correct { color: var(--success-color); }
        #feedback-status.wrong { color: var(--danger-color); }
        
        #pause-wait-btn { 
            display: none;
            margin: 0;
            flex-shrink: 0;
        }

        .high-scores-list-container {
            list-style: none; padding: 0; margin: 20px auto; max-width: 450px;
        }
        .high-scores-list-container li {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 12px; border-radius: 5px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 1.1em;
        }
        
        #stats-table {
            width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.9em;
        }
        #stats-table th, #stats-table td {
            border: 1px solid var(--primary-color); padding: 8px; text-align: center;
        }
        #stats-table th { background-color: var(--btn-bg); }
        #final-score-breakdown {
            font-size: 1.1em;
            line-height: 1.6;
        }
        #final-score-breakdown span {
            display: inline-block;
            margin: 0 10px;
        }
        #final-score-breakdown .correct-count { color: var(--success-color); }
        #final-score-breakdown .wrong-count { color: var(--danger-color); }

        @media (max-width: 767px) {
            .container { padding: 20px 15px; }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.3em; }
            #question-text { font-size: 1.3em; }
            #mcq-options { grid-template-columns: 1fr; }
            #game-header { font-size: 1em; gap: 10px; justify-content: center;}
            #feedback-status {font-size: 1.2em;}
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="setup-screen" class="screen active">
            <h1>Osmanlı Padişahları Bilgi Oyunu</h1>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="level-select">Seviye:</label>
                    <select id="level-select">
                        <option value="acemi">Acemi (4 Şıklı)</option>
                        <option value="orta">Orta (5 Şıklı - Ceza Puanlı)</option>
                        <option value="usta">Usta (Yazılı Cevap)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="question-count">Soru Sayısı:</label>
                    <select id="question-count">
                        <option value="5">5</option><option value="10" selected>10</option><option value="15">15</option><option value="30">30</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="time-limit">Soru Süresi (sn):</label>
                    <select id="time-limit">
                        <option value="10">10</option><option value="15" selected>15</option><option value="20">20</option><option value="30">30</option><option value="45">45</option><option value="60">60</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="wait-time">Sorular Arası Bekleme (sn):</label>
                    <select id="wait-time">
                        <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="10">10</option><option value="15">15</option>
                    </select>
                </div>
            </div>
            <div class="btn-group">
                <button id="start-btn" class="btn">Yeni Oyun</button>
                <button id="continue-btn" class="btn" style="display:none;">Oyuna Devam Et</button>
                <button id="show-high-scores-btn" class="btn" style="display:none;">Yüksek Skorlar</button>
                <button id="show-last-stats-btn" class="btn" style="display:none;">Son Oyun Detayları</button>
            </div>
            <div class="volume-control-wrapper" style="margin-top:20px;">
                    <label for="volume-slider">Ses Seviyesi</label>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.2">
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="game-header">
                <div id="question-counter"></div><div id="timer"></div><div id="score"></div>
            </div>
            <p id="question-text"></p>
            <div id="answer-area">
                <input type="text" id="answer-input" placeholder="Padişahın adını yazın...">
                <button id="submit-text-btn" class="btn" style="margin-top:10px;">Cevapla</button>
                <div id="mcq-options"></div>
            </div>
            <div id="feedback-area">
                <div id="feedback-status-wrapper">
                    <div id="feedback-status"></div>
                    <button id="pause-wait-btn" class="btn btn-small">Durdur</button>
                </div>
                <div id="feedback-details"></div>
            </div>
        </div>

        <div id="end-screen" class="screen">
            <h2>Yarışma Bitti!</h2>
            <div id="final-score-breakdown"></div>
            <p id="final-score" style="font-size: 1.8em; margin-top: 15px;"></p>
            <h3>Yüksek Skorlar</h3>
            <ul id="end-screen-high-scores-list" class="high-scores-list-container"></ul>
            <div id="high-score-form" style="display: none;">
                <p>Tebrikler! Yüksek skor tablosuna girdiniz.</p>
                <input type="text" id="player-name" placeholder="Adınızı girin (3 harf)" maxlength="3">
                <button id="save-score-btn" class="btn">Kaydet</button>
            </div>
            <div class="btn-group">
                <button id="play-again-btn" class="btn">Yeniden Oyna</button>
                <button id="show-stats-btn" class="btn">Sonuç Detayları</button>
                <button id="reset-scores-btn" class="btn">Skorları Sıfırla</button>
            </div>
        </div>
        
        <div id="high-scores-screen" class="screen">
            <h2>Yüksek Skorlar</h2>
            <ul id="main-high-scores-list" class="high-scores-list-container"></ul>
            <button id="back-to-setup-btn" class="btn">Geri Dön</button>
        </div>

        <div id="stats-screen" class="screen">
            <h2>İstatistikler</h2>
            <table id="stats-table">
                <thead><tr><th>#</th><th>Yıl</th><th>Doğru Cevap</th><th>Sizin Cevabınız</th><th>Süre (sn)</th><th>Sonuç</th></tr></thead>
                <tbody id="stats-tbody"></tbody>
            </table>
            <button id="back-to-end-btn" class="btn">Geri Dön</button>
        </div>
    </div>

    <audio id="background-music" loop src="https://www.bensound.com/bensound-music/bensound-theduel.mp3"></audio>
    
    <script>
    // --- DATA (Full and Verified) ---
    const padisahlar = [
        { names: ["osman gazi", "i. osman", "osman bey", "1 osman"], start: 1299, end: 1326, details: { "Genel Ansiklopedi": "Osmanlı Devleti'nin kurucusu ve ilk padişahıdır. Ertuğrul Gazi'nin oğlu olarak Kayı aşiretinin liderliğini devralmış, Bizans sınırında bağımsız bir beylik kurmuştur. Adına ilk hutbeyi okutarak ve sikke bastırarak beyliğin bağımsızlığını ilan etmiş, devletin temellerini atmıştır." } },
        { names: ["orhan gazi", "i. orhan", "orhan bey", "1 orhan"], start: 1326, end: 1362, details: { "Genel Ansiklopedi": "Devletin kurumsallaşmasında kritik rol oynamıştır. Bursa'yı fethederek başkent yapmış, İznik ve İzmit'in fethiyle beyliğin Marmara'daki hâkimiyetini pekiştirmiştir. 'Sultan' unvanını kullanan ilk Osmanlı hükümdarı olduğu düşünülmektedir." } },
        { names: ["i. murad", "hüdavendigâr", "1 murad"], start: 1362, end: 1389, details: { "Genel Ansiklopedi": "'Sultan' unvanını ilk kez kullanan padişahtır. Balkanlar'da sistemli bir fetih politikası izlemiş, Edirne'yi fethederek başkent yapmıştır. I. Kosova Savaşı'nda şehit düşmüştür." } },
        { names: ["yıldırım bayezid", "i. bayezid", "yıldırım", "1 bayezid"], start: 1389, end: 1402, details: { "Genel Ansiklopedi": "Savaşlardaki sürati nedeniyle 'Yıldırım' lakabını almıştır. İstanbul'u kuşatmış ve Niğbolu Savaşı'nda büyük bir Haçlı ordusunu yenmiştir. 1402'de Ankara Savaşı'nda Timur'a yenilerek esir düşmesiyle Fetret Devri başlamıştır." } },
        { names: ["fetret", "fetret devri"], start: 1402, end: 1413, details: { "Genel Ansiklopedi": "Ankara Savaşı sonrası Yıldırım Bayezid'in oğulları arasında 11 yıl süren taht kavgaları dönemidir. Bu süreçte devlet dağılma tehlikesi geçirmiştir." } },
        { names: ["çelebi i. mehmed", "i. mehmed", "1 mehmed"], start: 1413, end: 1421, details: { "Genel Ansiklopedi": "Fetret Devri'ne son vererek devleti yeniden toparladığı için 'devletin ikinci kurucusu' olarak anılır." } },
        { names: ["ii. murad", "murad-ı sani", "2 murad"], start: 1421, end: 1444, details: { "Genel Ansiklopedi": "Varna Savaşı'nda Haçlıları yenilgiye uğratmıştır. Hayırsever kişiliğiyle tanınır ve birçok mimari eser yaptırmıştır. Tahtı kendi isteğiyle oğlu II. Mehmed'e bırakmıştır." } },
        { names: ["fatih sultan mehmed", "ii. mehmed", "fatih", "2 mehmed"], start: 1444, end: 1446, details: { "Genel Ansiklopedi": "Henüz 12 yaşındayken babasının tahtı kendisine bırakmasıyla ilk saltanatına başlamıştır. Bu kısa dönem, Varna Savaşı ile anılır." } },
        { names: ["ii. murad", "murad-ı sani", "2 murad"], start: 1446, end: 1451, details: { "Genel Ansiklopedi": "Varna zaferinden sonra yeniçerilerin isyanı ve devlet adamlarının ısrarı üzerine ikinci kez tahta geçmiştir. II. Kosova Zaferi'ni kazanarak Balkanlar'daki Türk hâkimiyetini kesinleştirmiştir." } },
        { names: ["fatih sultan mehmed", "ii. mehmed", "fatih", "2 mehmed"], start: 1451, end: 1481, details: { "Genel Ansiklopedi": "21 yaşında İstanbul'u fethederek 1000 yıllık Bizans İmparatorluğu'na son vermiş, bir çağı kapatıp yeni bir çağ açmıştır. Kanunname-i Âl-i Osman'ı yayınlayarak devlet yönetimini yazılı hale getirmiştir." } },
        { names: ["ii. bayezid", "bayezid-i veli", "2 bayezid"], start: 1481, end: 1512, details: { "Genel Ansiklopedi": "Saltanatının ilk yılları, kardeşi Cem Sultan'ın taht mücadelesiyle geçmiştir. Bu sorun, Osmanlı'nın fetih politikasını yavaşlatmıştır. Dindarlığı ile tanınır." } },
        { names: ["yavuz sultan selim", "i. selim", "yavuz", "1 selim"], start: 1512, end: 1520, details: { "Genel Ansiklopedi": "Sadece 8 yıl süren saltanatına rağmen Mercidabık ve Ridaniye savaşlarıyla Memlük Devleti'ne son vererek halifeliği Osmanlı'ya getirmiştir. İmparatorluk topraklarını yaklaşık 2.5 kat büyütmüştür." } },
        { names: ["kanuni sultan süleyman", "i. süleyman", "kanuni", "1 süleyman"], start: 1520, end: 1566, details: { "Genel Ansiklopedi": "46 yıl ile en uzun süre tahtta kalan padişahtır. Batıda 'Muhteşem', doğuda ise adaleti ve kanunları nedeniyle 'Kanuni' olarak anılır. İmparatorluk onun döneminde altın çağını yaşamıştır." } },
        { names: ["ii. selim", "sarı selim", "2 selim"], start: 1566, end: 1574, details: { "Genel Ansiklopedi": "Ordunun başında sefere çıkma geleneğini terk eden ilk padişahtır. Devlet işlerini büyük ölçüde Sadrazam Sokullu Mehmed Paşa'ya bırakmıştır. Kıbrıs onun döneminde fethedilmiştir." } },
        { names: ["iii. murad", "3 murad"], start: 1574, end: 1595, details: { "Genel Ansiklopedi": "Saltanatı sırasında Osmanlı toprakları Fas'a kadar genişleyerek en geniş sınırlarına ulaşmıştır. Ancak devlet idaresinde saray kadınlarının etkisi artmıştır." } },
        { names: ["iii. mehmed", "3 mehmed"], start: 1595, end: 1603, details: { "Genel Ansiklopedi": "Sancağa çıkan son şehzadedir. 'Eğri Fatihi' unvanını almıştır. Celali İsyanları onun döneminde Anadolu'da büyük bir yıkıma neden olmuştur." } },
        { names: ["i. ahmed", "1 ahmed"], start: 1603, end: 1617, details: { "Genel Ansiklopedi": "Kardeş katli geleneğine son veren Ekber ve Erşed sistemini getirmiştir. İstanbul'un simgelerinden Sultanahmet Camii'ni yaptırmıştır." } },
        { names: ["i. mustafa", "1 mustafa"], start: 1617, end: 1618, details: { "Genel Ansiklopedi": "Akli dengesinin yerinde olmaması nedeniyle sadece 96 gün sonra devlet adamları tarafından tahttan indirilmiştir. Osmanlı tarihinde iki kez tahta çıkıp iki kez indirilen tek padişahtır." } },
        { names: ["ii. osman", "genç osman", "2 osman"], start: 1618, end: 1622, details: { "Genel Ansiklopedi": "Çok genç yaşta tahta geçmiş, idealist ve reformcu bir padişahtır. Yeniçeri Ocağı'nı kaldırmayı planladığı için çıkan bir isyan sonucu trajik bir şekilde öldürülmüştür." } },
        { names: ["i. mustafa", "1 mustafa"], start: 1622, end: 1623, details: { "Genel Ansiklopedi": "Genç Osman'ın öldürülmesinden sonra isyancılar tarafından ikinci kez tahta çıkarılmıştır. Ancak devlet yönetimindeki yetersizliği nedeniyle kısa süre sonra tekrar indirilmiştir." } },
        { names: ["iv. murad", "bağdat fatihi", "4 murad"], start: 1623, end: 1640, details: { "Genel Ansiklopedi": "Mutlak otoriteyi eline almış, Celali isyanlarını ve Yeniçeri zorbalığını büyük bir sertlikle bastırmıştır. Tütün ve içki yasağıyla bilinir. Bağdat'ı fethetmiştir." } },
        { names: ["i. ibrahim", "1 ibrahim"], start: 1640, end: 1648, details: { "Genel Ansiklopedi": "Uzun süre 'kafes'te kaldıktan sonra tahta çıkmış, bu durum psikolojisini olumsuz etkilemiştir. İsraf ve ağır vergiler nedeniyle çıkan bir isyan sonucu tahttan indirilerek öldürülmüştür." } },
        { names: ["iv. mehmed", "avcı mehmed", "4 mehmed"], start: 1648, end: 1687, details: { "Genel Ansiklopedi": "Avcılığa olan aşırı tutkusu nedeniyle 'Avcı' lakabıyla anılır. Saltanatı, II. Viyana Kuşatması'ndaki (1683) büyük hezimetle bir dönüm noktası yaşamış ve bu yenilgi sonrası tahttan indirilmiştir." } },
        { names: ["ii. süleyman", "2 süleyman"], start: 1687, end: 1691, details: { "Genel Ansiklopedi": "Yaklaşık 40 yıl 'kafes' hayatı yaşadıktan sonra tahta geçmiştir. Saltanatı, Kutsal İttifak Savaşları'nın en çetin dönemine denk gelmiştir." } },
        { names: ["ii. ahmed", "2 ahmed"], start: 1691, end: 1695, details: { "Genel Ansiklopedi": "Ağabeyi gibi uzun bir 'kafes' hayatından sonra tahta çıkmıştır. Saltanatı boyunca Avusturya ile savaşlar devam etmiş ve Osmanlı ordusu ağır yenilgiler almıştır." } },
        { names: ["ii. mustafa", "2 mustafa"], start: 1695, end: 1703, details: { "Genel Ansiklopedi": "Ordunun başında sefere çıkma geleneğini canlandırmak istemiş, ancak Zenta'da ağır bir yenilgiye uğramıştır. Bu yenilgi sonrası Karlofça Antlaşması imzalanmıştır. Edirne Vakası ile tahttan indirilmiştir." } },
        { names: ["iii. ahmed", "3 ahmed"], start: 1703, end: 1730, details: { "Genel Ansiklopedi": "Saltanatı, Lale Devri (1718-1730) olarak bilinen barış, sanat ve yenileşme dönemiyle özdeşleşmiştir. İlk Türk matbaası onun döneminde kurulmuştur. Patrona Halil İsyanı ile tahttan indirilmiştir." } },
        { names: ["i. mahmud", "1 mahmud"], start: 1730, end: 1754, details: { "Genel Ansiklopedi": "Batı tarzı askeri ıslahatları başlatan ilk padişahtır. Humbaracı Ahmed Paşa'yı görevlendirerek Humbaracı Ocağı'nı modernleştirmiştir. Belgrad'ı geri almıştır." } },
        { names: ["iii. osman", "3 osman"], start: 1754, end: 1757, details: { "Genel Ansiklopedi": "51 yıl gibi çok uzun bir süre 'kafes' hayatı yaşadıktan sonra tahta çıkmıştır. Kısa süren saltanatında Nuruosmaniye Camii'ni tamamlatmıştır." } },
        { names: ["iii. mustafa", "3 mustafa"], start: 1757, end: 1774, details: { "Genel Ansiklopedi": "Devletin maliyesini ve ordusunu düzeltmek için reformlar yapmaya çalışmıştır. Deniz subayı yetiştirmek amacıyla bir okul açtırmıştır. Çeşme'de donanmanın yakılmasıyla sonuçlanan ağır bir Rus yenilgisi yaşamıştır." } },
        { names: ["i. abdülhamid", "1 abdülhamid"], start: 1774, end: 1789, details: { "Genel Ansiklopedi": "Saltanatının başında, Kırım'ın kaybedildiği ağır şartlar içeren Küçük Kaynarca Antlaşması'nı (1774) imzalamıştır. Islahatlara devam etmeye çalışmıştır." } },
        { names: ["iii. selim", "3 selim"], start: 1789, end: 1807, details: { "Genel Ansiklopedi": "Nizam-ı Cedid (Yeni Düzen) adıyla bilinen, devletin tüm kurumlarında köklü bir reform hareketi başlatmıştır. Kabakçı Mustafa İsyanı ile tahttan indirilip öldürülmüştür." } },
        { names: ["iv. mustafa", "4 mustafa"], start: 1807, end: 1808, details: { "Genel Ansiklopedi": "Nizam-ı Cedid reformlarına karşı olan isyancıların desteğiyle tahta çıkmıştır. Alemdar Mustafa Paşa'nın III. Selim'i tekrar tahta çıkarmak için gelmesi üzerine amcasını öldürtmüştür." } },
        { names: ["ii. mahmud", "2 mahmud"], start: 1808, end: 1839, details: { "Genel Ansiklopedi": "Osmanlı tarihinde en köklü reformları yapan padişahlardandır. 1826'da Yeniçeri Ocağı'nı ortadan kaldırmış (Vaka-i Hayriye), Divan'ı kaldırıp bakanlıkları kurmuştur." } },
        { names: ["abdülmecid", "i. abdülmecid", "1 abdülmecid"], start: 1839, end: 1861, details: { "Genel Ansiklopedi": "Tanzimat Fermanı'nı (1839) ve Islahat Fermanı'nı (1856) ilan ederek anayasal yönetime geçişin ilk adımlarını atmıştır. Dolmabahçe Sarayı'nı yaptırmıştır." } },
        { names: ["abdülaziz", "1 abdülaziz"], start: 1861, end: 1876, details: { "Genel Ansiklopedi": "Avrupa'ya seyahat eden ilk Osmanlı padişahıdır. Döneminin en güçlü üçüncü deniz filosunu kurdurmuştur. Darbeyle tahttan indirilmiş, kısa süre sonra şüpheli bir şekilde ölü bulunmuştur." } },
        { names: ["v. murad", "5 murad"], start: 1876, end: 1876, details: { "Genel Ansiklopedi": "En kısa süre tahtta kalan padişahtır (93 gün). Akli dengesi bozulduğu için tahttan indirilmiştir." } },
        { names: ["ii. abdülhamid", "2 abdülhamid"], start: 1876, end: 1909, details: { "Genel Ansiklopedi": "İlk Osmanlı anayasası olan Kanun-ı Esasi'yi ilan etmiş, ancak kısa süre sonra meclisi tatil ederek 30 yıl sürecek olan istibdat dönemini başlatmıştır. 31 Mart Vakası sonrası tahttan indirilmiştir." } },
        { names: ["mehmed v. reşad", "v. mehmed", "5 mehmed"], start: 1909, end: 1918, details: { "Genel Ansiklopedi": "II. Meşrutiyet döneminde, yetkileri sembolik olan bir padişahtır. Saltanatı Trablusgarp, Balkan ve I. Dünya Savaşları gibi büyük felaketlerle geçmiştir." } },
        { names: ["mehmed vi. vahdettin", "vi. mehmed", "vahdettin", "6 mehmed"], start: 1918, end: 1922, details: { "Genel Ansiklopedi": "Osmanlı Devleti'nin 36. ve son padişahıdır. Milli Mücadele'ye karşı olan İstanbul Hükümeti'nin başında bulunmuş, 1 Kasım 1922'de saltanatın kaldırılması üzerine ülkeyi terk etmiştir." } }
    ];

    // --- DOM ELEMENTS ---
    const allDomElements = { screens: document.querySelectorAll('.screen'), setupScreen: document.getElementById('setup-screen'), gameScreen: document.getElementById('game-screen'), endScreen: document.getElementById('end-screen'), highScoresScreen: document.getElementById('high-scores-screen'), statsScreen: document.getElementById('stats-screen'), levelSelect: document.getElementById('level-select'), questionCountSelect: document.getElementById('question-count'), timeLimitSelect: document.getElementById('time-limit'), waitTimeSelect: document.getElementById('wait-time'), startBtn: document.getElementById('start-btn'), continueBtn: document.getElementById('continue-btn'), showHighScoresBtn: document.getElementById('show-high-scores-btn'), showLastStatsBtn: document.getElementById('show-last-stats-btn'), backToSetupBtn: document.getElementById('back-to-setup-btn'), volumeSlider: document.getElementById('volume-slider'), questionCounterEl: document.getElementById('question-counter'), scoreEl: document.getElementById('score'), timerEl: document.getElementById('timer'), questionTextEl: document.getElementById('question-text'), answerInput: document.getElementById('answer-input'), submitTextBtn: document.getElementById('submit-text-btn'), mcqOptionsContainer: document.getElementById('mcq-options'), feedbackStatusEl: document.getElementById('feedback-status'), feedbackDetailsEl: document.getElementById('feedback-details'), pauseWaitBtn: document.getElementById('pause-wait-btn'), finalScoreEl: document.getElementById('final-score'), finalScoreBreakdownEl: document.getElementById('final-score-breakdown'), endScreenHighScoresListEl: document.getElementById('end-screen-high-scores-list'), mainHighScoresListEl: document.getElementById('main-high-scores-list'), highScoreForm: document.getElementById('high-score-form'), playerNameInput: document.getElementById('player-name'), saveScoreBtn: document.getElementById('save-score-btn'), playAgainBtn: document.getElementById('play-again-btn'), showStatsBtn: document.getElementById('show-stats-btn'), resetScoresBtn: document.getElementById('reset-scores-btn'), statsTbody: document.getElementById('stats-tbody'), backToEndBtn: document.getElementById('back-to-end-btn'), backgroundMusic: document.getElementById('background-music') };

    // --- GAME STATE ---
    let settings = {}, state = {}, timerInterval, highScores = JSON.parse(localStorage.getItem('ottomanHighScores_v4.4')) || [], audioCtx, isWaitTimerPaused = false;

    // --- FUNCTIONS ---
    function normalizeAnswer(str) { if (!str) return ''; let normalizedStr = str.toString().toLowerCase().replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's').replace(/ö/g, 'o').replace(/ç/g, 'c').replace(/â/g, 'a'); const romanMap = { 'vi': '6', 'v': '5', 'iv': '4', 'iii': '3', 'ii': '2', 'i': '1' }; for (const roman in romanMap) { normalizedStr = normalizedStr.replace(new RegExp('\\b' + roman + '\\b', 'g'), romanMap[roman]); } return normalizedStr.replace(/[^a-z0-9]/g, ''); }
    function switchScreen(screenId) { allDomElements.screens.forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); }
    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
    }

    function generateQuestions() {
        try {
            const yearPool = [];
            for (let y = 1299; y <= 1922; y++) { yearPool.push(y); }
            shuffleArray(yearPool);
            
            const selectedYears = yearPool.slice(0, settings.questionCount);
            const questions = [];
            const uniqueSultanNames = [...new Set(padisahlar.map(p => p.names[0]))];

            selectedYears.forEach(year => {
                const correctSultanObjects = padisahlar.filter(p => year >= p.start && year <= p.end);
                if (correctSultanObjects.length > 0) {
                    const correctSultan = correctSultanObjects[0];
                    const displayAnswer = correctSultan.names[0].split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    let options = [];
                    const isMCQ = settings.level === 'acemi' || settings.level === 'orta';
                    if (isMCQ) {
                        options.push(displayAnswer);
                        const distractorCount = settings.level === 'orta' ? 4 : 3;
                        const distractorPool = uniqueSultanNames.filter(name => name !== correctSultan.names[0] && !name.toLowerCase().includes("fetret"));
                        shuffleArray(distractorPool);
                        const distractors = distractorPool.slice(0, distractorCount).map(name => 
                            name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
                        );
                        options.push(...distractors);
                        shuffleArray(options);
                    }
                    questions.push({ year, correctSultanData: correctSultan, displayAnswer, mcqOptions: options });
                }
            });
            return questions;
        } catch (error) {
            console.error("Soru üretilirken bir hata oluştu:", error);
            alert("Kritik bir hata nedeniyle sorular üretilemedi. Lütfen sayfayı yenileyin.");
            return [];
        }
    }

    function startGame(isContinuation = false) { 
        if (isContinuation) { 
            state = JSON.parse(localStorage.getItem('ottomanHighScores_v4.4')); 
            settings = state.settings; 
        } else { 
            settings = { level: allDomElements.levelSelect.value, questionCount: parseInt(allDomElements.questionCountSelect.value), timeLimit: parseInt(allDomElements.timeLimitSelect.value), waitTime: parseInt(allDomElements.waitTimeSelect.value) }; 
            const generatedQuestions = generateQuestions(); 
            if(generatedQuestions.length < settings.questionCount) {
                alert('Yeterli soru üretilemedi. Lütfen ayarları kontrol edip tekrar deneyin.');
                return;
            }
            state = { score: 0, correctAnswers: 0, incorrectAnswers: 0, currentQuestionIndex: 0, questions: generatedQuestions, settings: settings, results: [] }; 
        } 
        setupAudio(); 
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
        allDomElements.backgroundMusic.play().catch(e => console.log("Music play failed:", e)); 
        switchScreen('game-screen'); 
        nextQuestion(); 
    }
    
    function saveGameState() { if(state && state.currentQuestionIndex < settings.questionCount){ localStorage.setItem('ottomanHighScores_v4.4', JSON.stringify(state)); } }
    function clearSavedGame() { localStorage.removeItem('ottomanHighScores_v4.4'); allDomElements.continueBtn.style.display = 'none'; }
    
    function nextQuestion() { 
        if (state.currentQuestionIndex >= settings.questionCount) { endGame(); return; } 
        allDomElements.pauseWaitBtn.style.display = 'none'; 
        const question = state.questions[state.currentQuestionIndex]; 
        allDomElements.questionTextEl.textContent = `${question.year} yılında tahtta olan padişah kimdi?`; 
        allDomElements.feedbackStatusEl.textContent = ''; 
        allDomElements.feedbackDetailsEl.innerHTML = ''; 
        if (settings.level === 'usta') { 
            allDomElements.answerInput.style.display = 'block'; 
            allDomElements.submitTextBtn.style.display = 'inline-block'; 
            allDomElements.mcqOptionsContainer.style.display = 'none'; 
            allDomElements.answerInput.value = ''; 
            allDomElements.answerInput.disabled = false; 
            allDomElements.submitTextBtn.disabled = false; 
            allDomElements.answerInput.focus(); 
        } else { 
            allDomElements.answerInput.style.display = 'none'; 
            allDomElements.submitTextBtn.style.display = 'none'; 
            allDomElements.mcqOptionsContainer.style.display = 'grid'; 
            allDomElements.mcqOptionsContainer.innerHTML = ''; 
            question.mcqOptions.forEach(option => { 
                const btn = document.createElement('button'); 
                btn.className = 'btn mcq-btn'; 
                btn.textContent = option; 
                btn.onclick = () => checkAnswer(option); 
                allDomElements.mcqOptionsContainer.appendChild(btn); 
            }); 
        } 
        updateUI(); 
        startTimer(); 
    }
    
    function startTimer() { 
        clearInterval(timerInterval); 
        state.questionStartTime = Date.now(); 
        let timeLeft = settings.timeLimit; 
        allDomElements.timerEl.textContent = timeLeft; 
        allDomElements.timerEl.style.color = 'var(--secondary-color)'; 
        allDomElements.timerEl.style.background = 'var(--btn-bg)'; 
        timerInterval = setInterval(() => { 
            timeLeft--; 
            allDomElements.timerEl.textContent = timeLeft; 
            if (timeLeft <= 5) allDomElements.timerEl.style.color = 'var(--danger-color)'; 
            if (timeLeft <= 0) { clearInterval(timerInterval); checkAnswer(null, true); } 
        }, 1000); 
    }
    
    function checkAnswer(userAnswer, timeUp = false) { 
        clearInterval(timerInterval); 
        const answerTime = timeUp ? settings.timeLimit : (Date.now() - state.questionStartTime) / 1000; 
        if (settings.level === 'usta') { 
            userAnswer = allDomElements.answerInput.value; 
            allDomElements.answerInput.disabled = true; 
            allDomElements.submitTextBtn.disabled = true; 
        } else { 
            allDomElements.mcqOptionsContainer.querySelectorAll('button').forEach(b => b.disabled = true); 
        } 
        const question = state.questions[state.currentQuestionIndex]; 
        const normalizedUserAnswer = normalizeAnswer(userAnswer); 
        const correctNormalizedAnswers = question.correctSultanData.names.map(normalizeAnswer); 
        const isCorrect = !timeUp && correctNormalizedAnswers.includes(normalizedUserAnswer); 
        
        if (isCorrect) { 
            state.correctAnswers++; 
            allDomElements.feedbackStatusEl.textContent = 'Doğru!'; 
            allDomElements.feedbackStatusEl.className = 'correct'; 
            playSound('correct'); 
        } else { 
            state.incorrectAnswers++;
            allDomElements.feedbackStatusEl.textContent = timeUp ? 'Süre Doldu!' : 'Yanlış!'; 
            allDomElements.feedbackStatusEl.className = 'wrong'; 
            playSound('wrong'); 
        } 
        
        allDomElements.feedbackDetailsEl.innerHTML = `<strong>${question.displayAnswer}:</strong> ${question.correctSultanData.details['Genel Ansiklopedi']}`; 
        state.results.push({ year: question.year, correctAnswer: question.displayAnswer, userAnswer: userAnswer || "Cevapsız", isCorrect: isCorrect, answerTime: answerTime }); 
        updateUI(); 
        state.currentQuestionIndex++; 
        allDomElements.pauseWaitBtn.style.display = 'inline-block'; 
        allDomElements.pauseWaitBtn.textContent = 'Durdur'; 
        isWaitTimerPaused = false; 
        startWaitTimer(); 
    }

    function startWaitTimer() { 
        clearInterval(timerInterval); 
        let waitLeft = settings.waitTime; 
        allDomElements.timerEl.style.background = 'var(--primary-color)'; 
        allDomElements.timerEl.style.color = 'var(--secondary-color)'; 
        allDomElements.timerEl.innerHTML = `${waitLeft}s`; 
        timerInterval = setInterval(() => { 
            if (!isWaitTimerPaused) { 
                waitLeft--; 
                allDomElements.timerEl.innerHTML = `${waitLeft}s`; 
                if (waitLeft <= 0) { clearInterval(timerInterval); nextQuestion(); } 
            } 
        }, 1000); 
    }
    
    function updateUI() { 
        allDomElements.scoreEl.textContent = `Puan: ${state.correctAnswers * 10}`;
        const questionNum = Math.min(state.currentQuestionIndex + 1, settings.questionCount); 
        allDomElements.questionCounterEl.textContent = `Soru: ${questionNum}/${settings.questionCount}`; 
    }

    function endGame() { 
        clearSavedGame(); 
        localStorage.setItem('ottomanLastGameResults_v4.4', JSON.stringify(state.results));

        const baseScore = state.correctAnswers * 10;
        let penaltyPoints = 0;
        allDomElements.finalScoreBreakdownEl.innerHTML = ''; // Clear previous breakdown

        if (settings.level === 'orta') {
            const penaltyCount = Math.floor(state.incorrectAnswers / 4);
            penaltyPoints = penaltyCount * 10;
            allDomElements.finalScoreBreakdownEl.innerHTML = `
                <span class="correct-count">Doğru: ${state.correctAnswers}</span>
                <span class="wrong-count">Yanlış: ${state.incorrectAnswers}</span>
                <span>Ceza Puanı: -${penaltyPoints}</span>
            `;
        } else {
             allDomElements.finalScoreBreakdownEl.innerHTML = `
                <span class="correct-count">Doğru: ${state.correctAnswers}</span>
                <span class="wrong-count">Yanlış: ${state.incorrectAnswers}</span>
            `;
        }
        
        state.score = baseScore - penaltyPoints;
        allDomElements.finalScoreEl.textContent = `Toplam Puan: ${state.score}`;
        
        displayHighScores(); 
        checkNewHighScore(); 
        switchScreen('end-screen'); 
    }
    
    function displayHighScores() { 
        highScores.sort((a, b) => b.score - a.score); 
        const highScoresHTML = highScores.slice(0, 5).map((s, index) => `<li><span>${index + 1}. ${s.name} - ${s.score} Puan</span><button class="btn btn-small stats-view-btn" data-index="${index}">İstatistik</button></li>`).join('') || "<li>Henüz kayıtlı skor yok.</li>";
        allDomElements.endScreenHighScoresListEl.innerHTML = highScoresHTML;
        allDomElements.mainHighScoresListEl.innerHTML = highScoresHTML;
    }

    function checkNewHighScore() { const lowestHighScore = highScores.length < 5 ? 0 : highScores[4].score; if (state.score > lowestHighScore) { allDomElements.highScoreForm.style.display = 'block'; } else { allDomElements.highScoreForm.style.display = 'none'; } }
    
    function saveHighScore() { 
        const name = allDomElements.playerNameInput.value.toUpperCase().trim() || '???'; 
        highScores.push({ name, score: state.score, results: state.results, level: settings.level }); 
        highScores.sort((a, b) => b.score - a.score); 
        highScores = highScores.slice(0, 5); 
        localStorage.setItem('ottomanHighScores_v4.4', JSON.stringify(highScores)); 
        allDomElements.highScoreForm.style.display = 'none'; 
        displayHighScores(); 
        allDomElements.showHighScoresBtn.style.display = 'inline-block';
    }
    
    function resetHighScores() { 
        const password = prompt("Skorları sıfırlamak için şifreyi girin:", ""); 
        if (password === "0000") { 
            highScores = []; 
            localStorage.removeItem('ottomanHighScores_v4.4'); 
            localStorage.removeItem('ottomanLastGameResults_v4.4'); 
            allDomElements.showLastStatsBtn.style.display = 'none'; 
            allDomElements.showHighScoresBtn.style.display = 'none';
            displayHighScores(); 
            alert("Yüksek skorlar ve geçmiş oyun verileri sıfırlandı."); 
        } else if (password !== null) { 
            alert("Yanlış şifre!"); 
        } 
    }

    function displayStats(resultsArray) { allDomElements.statsTbody.innerHTML = ''; resultsArray.forEach((result, index) => { const row = `<tr><td>${index + 1}</td><td>${result.year}</td><td>${result.correctAnswer}</td><td>${result.userAnswer}</td><td>${result.answerTime.toFixed(1)}</td><td>${result.isCorrect ? '✔️' : '❌'}</td></tr>`; allDomElements.statsTbody.innerHTML += row; }); switchScreen('stats-screen'); }
    function setupAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playSound(type) { if (!audioCtx || audioCtx.state === 'suspended') return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.1 * (allDomElements.volumeSlider.value * 2), audioCtx.currentTime); if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); } else { o.type = 'square'; o.frequency.setValueAtTime(150, audioCtx.currentTime); } g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.5); }
    
    function initializeApp() { 
        allDomElements.backgroundMusic.volume = allDomElements.volumeSlider.value; 
        if (localStorage.getItem('ottomanHighScores_v4.4')) { allDomElements.continueBtn.style.display = 'inline-block'; } 
        if (localStorage.getItem('ottomanLastGameResults_v4.4')) { allDomElements.showLastStatsBtn.style.display = 'inline-block'; }
        if (highScores.length > 0) { allDomElements.showHighScoresBtn.style.display = 'inline-block'; }
        
        allDomElements.startBtn.addEventListener('click', () => { if (localStorage.getItem('ottomanHighScores_v4.4')) { if (confirm("Kaydedilmiş bir oyun var. Yeni bir oyuna başlamak istediğinizden emin misiniz? (İlerlemeniz silinecek)")) { clearSavedGame(); startGame(false); } } else { startGame(false); } }); 
        allDomElements.continueBtn.addEventListener('click', () => startGame(true)); 
        allDomElements.showLastStatsBtn.addEventListener('click', () => {
            const lastResults = JSON.parse(localStorage.getItem('ottomanLastGameResults_v4.4'));
            if(lastResults && lastResults.length > 0) {
                displayStats(lastResults);
            } else {
                alert("Son oyuna ait detay bulunamadı.");
            }
        });
        allDomElements.showHighScoresBtn.addEventListener('click', () => {
            displayHighScores();
            switchScreen('high-scores-screen');
        });
        allDomElements.backToSetupBtn.addEventListener('click', () => switchScreen('setup-screen'));
        allDomElements.answerInput.addEventListener('keyup', (e) => { if (e.key === 'Enter' && !allDomElements.submitTextBtn.disabled) allDomElements.submitTextBtn.click(); }); 
        allDomElements.submitTextBtn.addEventListener('click', () => checkAnswer(null)); 
        allDomElements.playAgainBtn.addEventListener('click', () => { clearSavedGame(); switchScreen('setup-screen'); }); 
        allDomElements.saveScoreBtn.addEventListener('click', saveHighScore); 
        allDomElements.resetScoresBtn.addEventListener('click', resetHighScores); 
        allDomElements.showStatsBtn.addEventListener('click', () => displayStats(state.results)); 
        allDomElements.backToEndBtn.addEventListener('click', () => switchScreen('end-screen')); 
        allDomElements.volumeSlider.addEventListener('input', () => { allDomElements.backgroundMusic.volume = allDomElements.volumeSlider.value; }); 
        allDomElements.endScreenHighScoresListEl.addEventListener('click', (e) => { if (e.target.classList.contains('stats-view-btn')) { const index = e.target.dataset.index; if (highScores[index] && highScores[index].results) { displayStats(highScores[index].results); } else { alert("Bu skor için istatistik verisi bulunamadı."); } } }); 
        allDomElements.mainHighScoresListEl.addEventListener('click', (e) => { if (e.target.classList.contains('stats-view-btn')) { const index = e.target.dataset.index; if (highScores[index] && highScores[index].results) { displayStats(highScores[index].results); } else { alert("Bu skor için istatistik verisi bulunamadı."); } } }); 
        allDomElements.pauseWaitBtn.addEventListener('click', () => { isWaitTimerPaused = !isWaitTimerPaused; allDomElements.pauseWaitBtn.textContent = isWaitTimerPaused ? 'Devam Et' : 'Durdur'; }); 
        window.addEventListener('beforeunload', () => { if (allDomElements.gameScreen.classList.contains('active')) { saveGameState(); } }); 
    }
    
    initializeApp();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(() => console.log("✔ Service Worker yüklendi"))
            .catch(err => console.error("Service Worker hatası:", err));
        }
      </script>      
</body>
</html>